<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Daily Tasks</title>

<style>
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family: Arial, Helvetica, sans-serif;
}

/* BACK BUTTON */
.back-btn{
  position:fixed;
  top:20px;
  left:20px;
  font-size:22px;
  cursor:pointer;
  color:white;
  background:rgba(0,0,0,0.4);
  width:40px;
  height:40px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:0.3s;
  z-index:1000;
}

.back-btn:hover{
  background:rgba(34,197,94,0.8);
}

body{
  background:#020617;
  color:white;
  min-height:100vh;
}

/* ‚úÖ CONTENT WRAPPER */
.page-content{
  padding:90px 40px 40px;
}

h1{
  margin-bottom:10px;
}

.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

input[type="date"]{
  padding:8px;
  border-radius:8px;
  border:none;
}

/* ADD TASK */
.add-task{
  display:flex;
  gap:10px;
  margin-bottom:20px;
}

.add-task input{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:none;
}

.add-task button{
  padding:10px 16px;
  border:none;
  border-radius:10px;
  background:#22c55e;
  cursor:pointer;
}

/* TASK LIST */
.task{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  border:1px solid #334155;
  border-radius:12px;
  margin-bottom:10px;
}

.task.done{
  background:#14532d;
  text-decoration:line-through;
  opacity:0.85;
  border:none;
}

/* SUMMARY */
.summary{
  margin-top:25px;
  border-top:1px solid #334155;
  padding-top:15px;
}

.summary p{
  margin:5px 0;
}

/* CELEBRATION POPUP */
#celebrate{
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#020617;
  padding:30px 40px;
  border-radius:20px;
  text-align:center;
  box-shadow:0 0 30px rgba(34,197,94,0.6);
  z-index:1000;
}

#celebrate h1{
  color:#22c55e;
  margin-bottom:10px;
}

/* CONFETTI */
#confetti{
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  pointer-events:none;
  overflow:hidden;
  z-index:999;
}

.confetti-piece{
  position:absolute;
  width:10px;
  height:10px;
  background:gold;
  animation:fall 3s linear forwards;
}

@keyframes fall{
  0%{
    transform:translateY(-10px) rotate(0deg);
    opacity:1;
  }
  100%{
    transform:translateY(100vh) rotate(360deg);
    opacity:0;
  }
}

.note{
  opacity:0.7;
  font-size:14px;
  margin-top:10px;
}

#endDayBtn{
  margin-top:20px;
  padding:12px 20px;
  border:none;
  border-radius:12px;
  background:#22c55e;
  cursor:pointer;
}
/* CONFETTI */
#confetti-container {
  position: fixed;
  inset: 0;
  pointer-events: none;
  overflow: hidden;
  z-index: 9999;
}

.confetti {
  position: absolute;
  width: 8px;
  height: 14px;
  opacity: 0.9;
  animation: fly 1.5s ease-out forwards;
}

@keyframes fly {
  from {
    transform: translate(0, 0) rotate(0deg);
    opacity: 1;
  }
  to {
    transform: translate(var(--x), var(--y)) rotate(720deg);
    opacity: 0;
  }
}

/* POPUP */
.popup {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.popup-box {
  background: #020617;
  border: 1px solid #22c55e;
  padding: 30px;
  border-radius: 16px;
  text-align: center;
  color: white;
}

.popup-box h2 {
  margin-bottom: 10px;
  color: #22c55e;
}

.popup-box button {
  margin-top: 15px;
  padding: 10px 20px;
  background: #22c55e;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: bold;
}

</style>
</head>

<body>

<!-- ‚¨Ö BACK BUTTON -->
<div class="back-btn" onclick="goBack()">‚Üê</div>

<!-- ‚úÖ PAGE CONTENT -->
<div class="page-content">

<h1>Daily Tasks</h1>

<div class="top-bar">
  <div id="currentDate"></div>
  <input type="date" id="datePicker">
</div>

<!-- ADD TASK -->
<div class="add-task">
  <input id="taskInput" placeholder="Add task for the day">
  <button onclick="addTask()">Add</button>
</div>

<!-- TASK LIST -->
<div id="taskList"></div>

<!-- SUMMARY -->
<div class="summary">
  <p><strong>Planned:</strong> <span id="planned">0</span></p>
  <p><strong>Completed:</strong> <span id="completed">0</span></p>
  <p><strong>Completion:</strong> <span id="percentage">0%</span></p>

  <p class="note">
    You can view previous days using the date selector above.
    Tasks from previous days are read-only.
  </p>
</div>

<button onclick="endDay()" id="endDayBtn">End My Day</button>

</div>

<!-- CELEBRATION -->
<div id="celebrate">
  <h1>üéâ Hooray!</h1>
  <p>You completed all tasks for today üéØ</p>
</div>

<div id="confetti"></div>
<script>
/* ================= USER CHECK ================= */
const userId = localStorage.getItem("user_id");
if (!userId) {
  alert("User not logged in");
  window.location.href = "frontpage.html";
}

/* ================= DOM ================= */
const taskInput = document.getElementById("taskInput");
const taskList = document.getElementById("taskList");
const planned = document.getElementById("planned");
const completedEl = document.getElementById("completed");
const percentageEl = document.getElementById("percentage");
const datePicker = document.getElementById("datePicker");
const currentDate = document.getElementById("currentDate");

/* ================= DATE ================= */
const today = new Date().toISOString().split("T")[0];
datePicker.value = today;
let selectedDate = today;
currentDate.innerText = "Date: " + selectedDate;

/* ================= STATE ================= */
let tasks = [];

/* ================= LOAD TASKS ================= */
function loadTasks() {
  fetch(`http://localhost:3000/tasks/${userId}/${selectedDate}`)
    .then(res => res.json())
    .then(data => {
      tasks = data;
      render();
    })
    .catch(err => console.error("Load tasks error:", err));
}

/* ================= END DAY ================= */
function endDay() {
  if (tasks.length === 0) {
    alert("No tasks added today");
    return;
  }

  const completed = tasks.filter(t => t.done).length;

  if (completed !== tasks.length) {
    alert("Please complete all tasks before ending the day");
    return;
  }

  // üéä BLAST FROM BOTH SIDES
  blastConfetti();

  // üéâ SHOW POPUP
  setTimeout(() => {
    document.getElementById("success-popup").style.display = "flex";
  }, 300);

  // üîí LOCK INPUT
  taskInput.disabled = true;
}

/* ================= ADD TASK ================= */
function addTask() {
  const text = taskInput.value.trim();
  if (!text) return;

  fetch("http://localhost:3000/tasks/add", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      user_id: userId,
      task_date: selectedDate,
      text
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      taskInput.value = "";
      loadTasks();
    }
  });
}

/* ================= TOGGLE TASK ================= */
function toggleTask(i) {
  const task = tasks[i];

  fetch("http://localhost:3000/tasks/toggle", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id: task.id,
      done: !task.done
    })
  })
  .then(res => res.json())
  .then(() => loadTasks());
}

/* ================= DATE CHANGE ================= */
datePicker.onchange = () => {
  selectedDate = datePicker.value;
  currentDate.innerText = "Date: " + selectedDate;
  loadTasks();
};

/* ================= RENDER ================= */
function render() {
  taskList.innerHTML = "";
  let completed = 0;

  // 1Ô∏è‚É£ Render tasks and count completed
  tasks.forEach((t, i) => {
    if (t.done) completed++;

    const div = document.createElement("div");
    div.className = "task" + (t.done ? " done" : "");
    div.innerHTML = `
      <span>${t.text}</span>
      <span>${t.done ? "‚úÖ" : "‚¨ú"}</span>
    `;
    div.onclick = () => toggleTask(i);
    taskList.appendChild(div);
  });

  // 2Ô∏è‚É£ Update summary
  planned.innerText = tasks.length;
  document.getElementById("completed").innerText = completed;
  document.getElementById("percentage").innerText =
    tasks.length === 0 ? "0%" : Math.round((completed / tasks.length) * 100) + "%";

 
  // 3Ô∏è‚É£ Show celebration if all done for today
  
}

function blastConfetti() {
  const container = document.getElementById("confetti-container");
  const colors = [
    "#22c55e", "#4ade80", "#16a34a",
    "#facc15", "#38bdf8", "#e879f9"
  ];

  for (let i = 0; i < 80; i++) {
    const paper = document.createElement("div");
    paper.className = "confetti";
    paper.style.background =
      colors[Math.floor(Math.random() * colors.length)];

    const fromLeft = i % 2 === 0;

    paper.style.left = fromLeft ? "0px" : "100vw";
    paper.style.top = Math.random() * 100 + "vh";

    paper.style.setProperty(
      "--x",
      (fromLeft ? 1 : -1) * (300 + Math.random() * 400) + "px"
    );
    paper.style.setProperty(
      "--y",
      -200 - Math.random() * 400 + "px"
    );

    container.appendChild(paper);
    setTimeout(() => paper.remove(), 1500);
  }
}

function closePopup() {
  document.getElementById("success-popup").style.display = "none";
}

/* ================= BACK ================= */
function goBack() {
  window.location.href = "masterpage.html";
}

/* ================= INIT ================= */
loadTasks();
</script>
<!-- CONFETTI CONTAINER -->
<div id="confetti-container"></div>

<!-- SUCCESS POPUP -->
<div id="success-popup" class="popup">
  <div class="popup-box">
    <h2>üéâ Congratulations!</h2>
    <p>You completed today‚Äôs tasks perfectly</p>
    <button onclick="closePopup()">OK</button>
  </div>
</div>

</body>
</html>
